{% extends 'core/base.html' %}
{% load static %}

{% block content %}
<div class="container mt-5">
  <h2>Review Paper "As-Is"</h2>
  <form method="post" enctype="multipart/form-data" class="mb-4">
    {% csrf_token %}
    <input type="file" name="paper" class="form-control mb-3" accept=".docx">
    <button type="submit" class="btn btn-primary">Upload & Preview</button>
  </form>

  {% if blocks %}
  <form method="post" id="blocks-form">
    {% csrf_token %}
    <div class="d-flex justify-content-between mb-3">
      <button type="button" id="ai-classify-btn" class="btn btn-info">Auto-Classify with AI</button>
      <button type="submit" class="btn btn-success">Save Manual Edits</button>
    </div>

    <div class="mt-4">
      {% for block in blocks %}
        <div class="block mb-4 p-3 border rounded position-relative" data-index="{{ forloop.counter }}">
          <button type="button" class="btn btn-sm btn-danger position-absolute top-0 end-0 m-2 delete-block-btn">Ã—</button>
          <input type="hidden" name="delete_{{ forloop.counter }}" class="delete-flag" value="0">
          <div class="mb-2 d-flex align-items-center">
            <label class="me-2 fw-bold">Type:</label>
            <select name="type_{{ forloop.counter }}" class="form-select w-auto">
              <option value="question_header" {% if block.type == 'question_header' %}selected{% endif %}>Question Header</option>
              <option value="case_study" {% if block.type == 'case_study' %}selected{% endif %}>Case Study</option>
              <option value="paragraph" {% if block.type == 'paragraph' %}selected{% endif %}>Paragraph</option>
              <option value="table" {% if block.type == 'table' %}selected{% endif %}>Table</option>
              <option value="instruction" {% if block.type == 'instruction' %}selected{% endif %}>Instruction</option>
              <option value="rubric" {% if block.type == 'rubric' %}selected{% endif %}>Rubric</option>
              <option value="diagram" {% if block.type == 'diagram' %}selected{% endif %}>Diagram</option>
              <option value="figure" {% if block.type == 'figure' %}selected{% endif %}>Figure</option>
            </select>
          </div>

          {% if block.type == 'figure' %}
            <div class="text-center mb-3">
              <img src="{{ block.data_uri }}" class="img-fluid" alt="Figure">
            </div>
          {% elif block.type == 'table' %}
            <button type="button" class="btn btn-sm btn-outline-secondary mb-2 toggle-table-controls" data-index="{{ forloop.counter }}">Edit Table</button>
            <div class="table-responsive mb-2">
              <table class="table table-bordered editable-table" data-index="{{ forloop.counter }}">
                {% for row in block.rows %}
                  <tr>
                    {% for cell in row %}
                      <td>
                        <input type="text"
                               name="cell_{{ forloop.counter }}_{{ forloop.counter0 }}_{{ forloop.parentloop.counter0 }}"
                               value="{{ cell }}"
                               class="form-control form-control-sm">
                      </td>
                    {% endfor %}
                  </tr>
                {% endfor %}
              </table>
            </div>
            <div class="table-controls mb-3" data-index="{{ forloop.counter }}" style="display: none;">
              <button type="button" class="btn btn-sm btn-secondary add-row-btn" data-index="{{ forloop.counter }}">Add Row</button>
              <button type="button" class="btn btn-sm btn-secondary remove-row-btn" data-index="{{ forloop.counter }}">Remove Row</button>
              <button type="button" class="btn btn-sm btn-secondary add-col-btn" data-index="{{ forloop.counter }}">Add Column</button>
              <button type="button" class="btn btn-sm btn-secondary remove-col-btn" data-index="{{ forloop.counter }}">Remove Column</button>
            </div>
            <input type="hidden" name="rows_{{ forloop.counter }}" class="row-count" value="{{ block.rows|length }}">
            <input type="hidden" name="cols_{{ forloop.counter }}" class="col-count" value="{{ block.rows.0|length }}">
          {% else %}
            <textarea name="text_{{ forloop.counter }}" class="form-control" rows="3">{{ block.text }}</textarea>
          {% endif %}
        </div>
      {% endfor %}
    </div>
  </form>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
  // AI classify handler
  document.getElementById('ai-classify-btn').addEventListener('click', async () => {
    const blocks = Array.from(document.querySelectorAll('.block')).map(div => {
      const idx = div.dataset.index;
      const type = div.querySelector(`select[name='type_${idx}']`).value;
      if (type === 'figure') {
        return { type, data_uri: div.querySelector(`input[name='data_uri_${idx}']`).value };
      }
      if (type === 'table') {
        const rows = [];
        div.querySelectorAll('table tr').forEach(tr =>
          rows.push(Array.from(tr.cells).map(td => td.querySelector('input').value))
        );
        return { type, rows };
      }
      return { type, text: div.querySelector(`textarea[name='text_${idx}']`).value };
    });

    const resp = await fetch("{% url 'auto_classify_blocks' %}", {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': '{{ csrf_token }}'
      },
      body: JSON.stringify({ blocks })
    });
    if (!resp.ok) return;
    const { types } = await resp.json();
    types.forEach((t, i) => {
      document.querySelector(`select[name='type_${i+1}']`).value = t;
    });
  });

  // Delete block handler
  document.querySelectorAll('.delete-block-btn').forEach(btn =>
    btn.addEventListener('click', () => {
      const block = btn.closest('.block');
      block.querySelector(`input[name='delete_${block.dataset.index}']`).value = '1';
      block.style.display = 'none';
    })
  );

  // Toggle table controls (Add/Remove Row/Col)
  document.querySelectorAll('.toggle-table-controls').forEach(btn =>
    btn.addEventListener('click', () => {
      const idx = btn.dataset.index;
      const panel = document.querySelector(`.table-controls[data-index="${idx}"]`);
      panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
    })
  );

  // Add Row
  document.querySelectorAll('.add-row-btn').forEach(btn =>
    btn.addEventListener('click', () => {
      const idx = btn.dataset.index;
      const table = document.querySelector(`.editable-table[data-index="${idx}"]`);
      const rowCountInput = document.querySelector(`input.row-count[name="rows_${idx}"]`);
      let rows = parseInt(rowCountInput.value, 10);
      const cols = parseInt(document.querySelector(`input.col-count[name="cols_${idx}"]`).value, 10);
      const newRow = document.createElement('tr');
      for (let c = 0; c < cols; c++) {
        const td = document.createElement('td');
        td.innerHTML = `<input type="text" name="cell_${idx}_${rows}_${c}" class="form-control form-control-sm">`;
        newRow.appendChild(td);
      }
      table.appendChild(newRow);
      rowCountInput.value = rows + 1;
    })
  );

  // Remove Row
  document.querySelectorAll('.remove-row-btn').forEach(btn =>
    btn.addEventListener('click', () => {
      const idx = btn.dataset.index;
      const table = document.querySelector(`.editable-table[data-index="${idx}"]`);
      const rowCountInput = document.querySelector(`input.row-count[name="rows_${idx}"]`);
      let rows = parseInt(rowCountInput.value, 10);
      if (rows > 1) {
        table.deleteRow(rows - 1);
        rowCountInput.value = rows - 1;
      }
    })
  );

  // Add Column
  document.querySelectorAll('.add-col-btn').forEach(btn =>
    btn.addEventListener('click', () => {
      const idx = btn.dataset.index;
      const table = document.querySelector(`.editable-table[data-index="${idx}"]`);
      const colCountInput = document.querySelector(`input.col-count[name="cols_${idx}"]`);
      let cols = parseInt(colCountInput.value, 10);
      table.querySelectorAll('tr').forEach((tr, rowIndex) => {
        const td = document.createElement('td');
        td.innerHTML = `<input type="text" name="cell_${idx}_${rowIndex}_${cols}" class="form-control form-control-sm">`;
        tr.appendChild(td);
      });
      colCountInput.value = cols + 1;
    })
  );

  // Remove Column
  document.querySelectorAll('.remove-col-btn').forEach(btn =>
    btn.addEventListener('click', () => {
      const idx = btn.dataset.index;
      const table = document.querySelector(`.editable-table[data-index="${idx}"]`);
      const colCountInput = document.querySelector(`input.col-count[name="cols_${idx}"]`);
      let cols = parseInt(colCountInput.value, 10);
      if (cols > 1) {
        table.querySelectorAll('tr').forEach(tr => tr.deleteCell(cols - 1));
        colCountInput.value = cols - 1;
      }
    })
  );
});
</script>

<style>
  .editable-table input { background: transparent; border: none; width: 100%; padding: .25rem; }
  .editable-table input:focus { background: #fff3cd; outline: 1px solid #ffc107; }
</style>
{% endif %}
{% endblock %}
