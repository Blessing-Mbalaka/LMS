{% extends 'core/base.html' %}
{% load static %}

{% block content %}
<div class="container mt-5">
  <h2>Review Paper "As-Is"</h2>
  <form method="post" enctype="multipart/form-data" class="mb-4">
    {% csrf_token %}
    <input type="file" name="paper" class="form-control mb-3" accept=".docx">
    <button type="submit" class="btn btn-primary">Upload & Preview</button>
  </form>

  {% if blocks %}
  <form method="post" id="blocks-form">
    {% csrf_token %}
    <div class="d-flex justify-content-between mb-3">
      <button type="button" id="ai-classify-btn" class="btn btn-info">Auto-Classify with AI</button>
      <button type="button" id="merge-btn" class="btn btn-warning">Merge Blocks</button>
      <button type="submit" class="btn btn-success">Save Manual Edits</button>
    </div>

    <div class="mt-4">
      {% for block in blocks %}
        <div class="block mb-4 p-3 border rounded position-relative"
             data-index="{{ forloop.counter }}"
             data-original="{{ block.original_text|escapejs }}">

          <!-- Delete -->
          <button type="button"
                  class="btn btn-sm btn-danger position-absolute top-0 end-0 m-2 delete-block-btn">√ó</button>
          <!-- Preview raw extraction -->
          <button type="button"
                  class="btn btn-sm btn-secondary position-absolute top-0 end-0 mt-5 me-2 preview-btn"
                  title="Preview raw extraction">üëÅÔ∏è</button>

          <input type="hidden" name="delete_{{ forloop.counter }}" class="delete-flag" value="0">

          <div class="mb-2 d-flex align-items-center">
            <label class="me-2 fw-bold">Type:</label>
            <select name="type_{{ forloop.counter }}" class="form-select w-auto">
              <option value="question_header" {% if block.type == "question_header" %}selected{% endif %}>Question Header</option>
              <option value="case_study" {% if block.type == "case_study" %}selected{% endif %}>Case Study</option>
              <option value="paragraph" {% if block.type == "paragraph" %}selected{% endif %}>Paragraph</option>
              <option value="table" {% if block.type == "table" %}selected{% endif %}>Table</option>
              <option value="instruction" {% if block.type == "instruction" %}selected{% endif %}>Instruction</option>
              <option value="rubric" {% if block.type == "rubric" %}selected{% endif %}>Rubric</option>
              <option value="diagram" {% if block.type == "diagram" %}selected{% endif %}>Diagram</option>
              <option value="figure" {% if block.type == "figure" %}selected{% endif %}>Figure</option>
            </select>
          </div>

          {% if block.type == 'figure' %}
            <div class="text-center mb-3">
              <img src="{{ block.data_uri }}" class="img-fluid" alt="Figure">
            </div>

          {% elif block.type == 'table' %}
            <button type="button" class="btn btn-sm btn-outline-secondary mb-2 toggle-table-controls" data-index="{{ forloop.counter }}">Edit Table</button>
            <div class="table-responsive mb-2">
              <table class="table table-bordered editable-table" data-index="{{ forloop.counter }}">
                {% for row in block.rows %}
                  <tr>
                    {% for cell in row %}
                      <td><input type="text" name="cell_{{ forloop.counter }}_{{ forloop.parentloop.counter0 }}_{{ forloop.counter0 }}" value="{{ cell }}" class="form-control form-control-sm"></td>
                    {% endfor %}
                  </tr>
                {% endfor %}
              </table>
            </div>
            <div class="table-controls mb-3" data-index="{{ forloop.counter }}" style="display:none;">
              <button type="button" class="btn btn-sm btn-secondary add-row-btn" data-index="{{ forloop.counter }}">Add Row</button>
              <button type="button" class="btn btn-sm btn-secondary remove-row-btn" data-index="{{ forloop.counter }}">Remove Row</button>
              <button type="button" class="btn btn-sm btn-secondary add-col-btn" data-index="{{ forloop.counter }}">Add Column</button>
              <button type="button" class="btn btn-sm btn-secondary remove-col-btn" data-index="{{ forloop.counter }}">Remove Column</button>
            </div>
            <input type="hidden" name="rows_{{ forloop.counter }}" class="row-count" value="{{ block.rows|length }}">
            <input type="hidden" name="cols_{{ forloop.counter }}" class="col-count" value="{{ block.rows.0|length }}">

          {% else %}
            <textarea name="text_{{ forloop.counter }}" class="form-control merged-textarea" rows="3">{{ block.text }}</textarea>
          {% endif %}
        </div>
      {% endfor %}
    </div>
  </form>
</div>

<!-- Preview Modal -->
<div id="preview-modal" class="d-none position-fixed top-50 start-50 translate-middle p-3 bg-white border rounded shadow" style="min-width:300px; z-index:1050;">
  <button type="button" id="preview-close" class="btn-close position-absolute top-0 end-0 m-2" aria-label="Close"></button>
  <div id="preview-content" class="mt-3"></div>
</div>
<div id="preview-backdrop" class="d-none position-fixed top-0 start-0 w-100 h-100 bg-dark opacity-50" style="z-index:1040;"></div>

<script>
document.addEventListener('DOMContentLoaded', () => {
  let mergeMode = false;
  const mergeBtn = document.getElementById('merge-btn');

  mergeBtn.addEventListener('click', () => {
    const blocks = Array.from(document.querySelectorAll('.block'));
    if (!mergeMode) {
      mergeMode = true;
      mergeBtn.textContent = 'Confirm Merge';
      mergeBtn.classList.replace('btn-warning', 'btn-success');
      blocks.forEach(b => b.addEventListener('click', selectHandler));
    } else {
      const selected = blocks.filter(b => b.classList.contains('selected'));
      if (selected.length < 2) {
        alert('Select at least two blocks to merge');
        return;
      }
      const firstTextarea = selected[0].querySelector('textarea');
      let mergedText = '';
selected.forEach(b => {
  const ta = b.querySelector('textarea');
  if (ta) {
    mergedText += ta.value.trim() + '\n';
  } else {
    const table = b.querySelector('table');
    if (table) {
      // Convert table rows to plain text
      const rows = Array.from(table.rows).map(row => 
        Array.from(row.cells).map(cell => cell.querySelector('input')?.value || '').join('\t')
      );
      mergedText += '[Table]\n' + rows.join('\n') + '\n';
    } else if (b.querySelector('img')) {
      mergedText += '[Image Block]\n';
    } else {
      mergedText += '[Unknown Block Type]\n';
    }
  }
});
      if (firstTextarea) firstTextarea.value = mergedText;
      selected.slice(1).forEach(b => {
        b.querySelector('input.delete-flag').value = '1';
        b.style.display = 'none';
      });
      blocks.forEach(b => {
        b.classList.remove('selected');
        b.removeEventListener('click', selectHandler);
      });
      mergeMode = false;
      mergeBtn.textContent = 'Merge Blocks';
      mergeBtn.classList.replace('btn-success', 'btn-warning');
    }
  });

  function selectHandler(e) {
    if (!mergeMode) return;
    const block = e.currentTarget;
    block.classList.toggle('selected');
    e.stopPropagation();
  }

  // Block type change: paragraph ‚Üî table
document.querySelectorAll('select[name^="type_"]').forEach(select => {
  select.addEventListener('change', (e) => {
    const type = e.target.value;
    const block = e.target.closest('.block');
    const index = block.dataset.index;

    if (type === 'table') {
      // Convert textarea to table
      const ta = block.querySelector('textarea');
      if (ta) {
        const lines = ta.value.trim().split('\n');
        const table = document.createElement('table');
        table.className = 'table table-bordered editable-table';
        table.setAttribute('data-index', index);
        lines.forEach((line, r) => {
          const tr = document.createElement('tr');
          line.split('\t').forEach((cell, c) => {
            tr.innerHTML += `<td><input type="text" name="cell_${index}_${r}_${c}" value="${cell}" class="form-control form-control-sm"></td>`;
          });
          table.appendChild(tr);
        });
        ta.replaceWith(table);
      }
    }

    if (type === 'paragraph') {
      // Convert table to textarea
      const table = block.querySelector('table');
      if (table) {
        const lines = Array.from(table.rows).map(row =>
          Array.from(row.cells).map(cell =>
            cell.querySelector('input')?.value || ''
          ).join('\t')
        );
        const textarea = document.createElement('textarea');
        textarea.name = `text_${index}`;
        textarea.className = 'form-control merged-textarea';
        textarea.rows = 3;
        textarea.value = lines.join('\n');
        table.replaceWith(textarea);
      }
    }
  });
});

});
</script>

<style>
.block.selected {
  border-color: #0d6efd !important;
  background-color: #e7f1ff;
}
</style>
{% endif %}
{% endblock %}
