{% extends 'core/base.html' %}
{% load static %}

{% block content %}
<div class="container mt-5">
  <h2>Review Paper \"As-Is\"</h2>
  <form method="post" enctype="multipart/form-data" class="mb-4">
    {% csrf_token %}
    <input type="file" name="paper" class="form-control mb-3" accept=".docx">
    <button type="submit" class="btn btn-primary">Upload & Preview</button>
  </form>

  {% if blocks %}
  <form method="post" id="blocks-form">
    {% csrf_token %}
    {# Sticky top controls #}
    <div id="top-controls" class="d-flex justify-content-between mb-3" style="position:sticky; top:0; background-color:#fff; z-index:1000; padding:1rem 0;">
      <button type="button" id="ai-classify-btn" class="btn btn-info">Auto-Classify with AI</button>
  
      <button type="button" id="merge-text-btn" class="btn btn-warning">Merge Text</button>
      <button type="button" id="merge-blocks-btn" class="btn btn-secondary ms-2">Merge Blocks</button>

      <button type="submit" class="btn btn-success">Save Manual Edits</button>
    </div>

    <div class="mt-4">
      {% for block in blocks %}
        <div class="block mb-4 p-3 border rounded position-relative" data-index="{{ forloop.counter }}" data-original="{{ block.original_text|escapejs }}">

          <!-- Delete -->
          <button type="button" class="btn btn-sm btn-danger position-absolute top-0 end-0 m-2 delete-block-btn">√ó</button>
          <!-- Preview raw extraction -->
          <button type="button" class="btn btn-sm btn-secondary position-absolute top-0 end-0 mt-5 me-2 preview-btn" title="Preview raw extraction">üëÅÔ∏è</button>

          <input type="hidden" name="delete_{{ forloop.counter }}" class="delete-flag" value="0">

          <!-- Classification dropdown -->
         <div class="mb-2 d-flex align-items-center">
            <label class="me-2 fw-bold">Type:</label>
            <select name="type_{{ forloop.counter }}" class="form-select w-auto">
              <option value="question_header" {% if block.type == 'question_header' %}selected{% endif %}>Question Header</option>
              <option value="case_study" {% if block.type == 'case_study' %}selected{% endif %}>Case Study</option>
              <option value="paragraph" {% if block.type == 'paragraph' %}selected{% endif %}>Paragraph</option>
              <option value="table" {% if block.type == 'table' %}selected{% endif %}>Table</option>
              <option value="instruction" {% if block.type == 'instruction' %}selected{% endif %}>Instruction</option>
              <option value="rubric" {% if block.type == 'rubric' %}selected{% endif %}>Rubric</option>
              <option value="diagram" {% if block.type == 'diagram' %}selected{% endif %}>Diagram</option>
              <option value="figure" {% if block.type == 'figure' %}selected{% endif %}>Figure</option>
            </select>
            <!-- Assign Question Modal Trigger -->
            <button type="button" class="btn btn-sm btn-primary ms-3" data-bs-toggle="modal" data-bs-target="#questionModal" data-block-index="{{ forloop.counter }}">
              Assign Question
            </button>
          </div>

          <!-- Block content by type -->
          {% if block.type == 'figure' %}
            <div class="text-center mb-3">
              <img src="{{ block.data_uri }}" class="img-fluid" alt="Figure">
            </div>

          {% elif block.type == 'table' %}
            <button type="button" class="btn btn-sm btn-outline-secondary mb-2 toggle-table-controls" data-index="{{ forloop.counter }}">Edit Table</button>
            <div class="table-responsive mb-2">
              <table class="table table-bordered editable-table" data-index="{{ forloop.counter }}">
                {% for row in block.rows %}
                  <tr>
                    {% for cell in row %}
                      <td><input type="text" name="cell_{{ forloop.counter }}_{{ forloop.parentloop.counter0 }}_{{ forloop.counter0 }}" value="{{ cell }}" class="form-control form-control-sm"></td>
                    {% endfor %}
                  </tr>
                {% endfor %}
              </table>
            </div>
            <div class="table-controls mb-3" data-index="{{ forloop.counter }}" style="display:none;">
              <button type="button" class="btn btn-sm btn-secondary add-row-btn" data-index="{{ forloop.counter }}">Add Row</button>
              <button type="button" class="btn btn-sm btn-secondary remove-row-btn" data-index="{{ forloop.counter }}">Remove Row</button>
              <button type="button" class="btn btn-sm btn-secondary add-col-btn" data-index="{{ forloop.counter }}">Add Column</button>
              <button type="button" class="btn btn-sm btn-secondary remove-col-btn" data-index="{{ forloop.counter }}">Remove Column</button>
            </div>
            <input type="hidden" name="rows_{{ forloop.counter }}" class="row-count" value="{{ block.rows|length }}">
            <input type="hidden" name="cols_{{ forloop.counter }}" class="col-count" value="{{ block.rows.0|length }}">

          {% elif block.type == 'question_header' %}
            <div class="mb-2">
              <label class="form-label fw-bold">Question Header:</label>
              <input type="text" name="text_{{ forloop.counter }}" class="form-control" value="{{ block.text }}">
              {% if block.marks %}
                <div><small class="text-muted">Marks: {{ block.marks }}</small></div>
              {% endif %}
            </div>

          {% elif block.type == 'case_study' %}
            <div class="mb-2">
              <label class="form-label fw-bold">Case Study:</label>
              <textarea name="text_{{ forloop.counter }}" class="form-control merged-textarea" rows="4">{{ block.text }}</textarea>
            </div>

          {% elif block.type == 'instruction' %}
            <div class="mb-3">
              <label class="form-label fw-bold">Instruction:</label>
              <textarea class="form-control" name="text_{{ forloop.counter }}" rows="5">{{ block.text }}</textarea>
            </div>

          {% else %}
            <textarea name="text_{{ forloop.counter }}" class="form-control merged-textarea" rows="3">{{ block.text }}</textarea>
          {% endif %}

        </div>
      {% endfor %}
    </div>
  </form>

  <!-- Question Assignment Modal -->
  <div class="modal fade" id="questionModal" tabindex="-1" aria-labelledby="questionModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="questionModalLabel">Assign Question</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <input type="hidden" id="modalBlockIndex" name="modalBlockIndex">
          <div class="mb-3">
            <label for="modalQuestionNumber" class="form-label">Question Number:</label>
            <input type="text" class="form-control" id="modalQuestionNumber" name="modalQuestionNumber">
          </div>
          <div class="mb-3">
            <label for="modalQuestionText" class="form-label">Question Text:</label>
            <textarea class="form-control" id="modalQuestionText" name="modalQuestionText" rows="3"></textarea>
          </div>
          <div class="mb-3">
            <label for="modalQuestionMarks" class="form-label">Marks:</label>
            <input type="number" class="form-control" id="modalQuestionMarks" name="modalQuestionMarks">
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          <button type="button" class="btn btn-primary" id="saveQuestionBtn">Save Question</button>
        </div>
      </div>
    </div>
  </div>

{% endif %}




</div>



<!-- Merge & AI Script -->
<script>
document.addEventListener('DOMContentLoaded', () => {
  // === AUTO-CLASSIFY FIRST SECTION AS INSTRUCTION ===
  const allBlocks = Array.from(document.querySelectorAll('.block'));
  let seenDivider = false;
  allBlocks.forEach(b => {
    const txt = (b.dataset.original || b.textContent || '').trim();
    if (!seenDivider && txt.startsWith('---')) {
      seenDivider = true;
      return;
    }
    if (!seenDivider && !b.querySelector('img')) {
      const sel = b.querySelector('select[name^="type_"]');
      if (sel) sel.value = 'instruction';
    }
  });

  // === MERGE MODE FLAGS ===
  let mergeMode = false;
  let mergeBlockMode = false;

  // === BUTTON ELEMENTS ===
  const mergeBtn = document.getElementById('merge-btn');
  const mergeBlocksBtn = document.getElementById('merge-blocks-btn');

  // === EVENT DELEGATED BLOCK SELECTOR ===
  document.addEventListener('click', (e) => {
    const blk = e.target.closest('.block');
    if (!blk) return;

    if (mergeMode || mergeBlockMode) {
      blk.classList.toggle('selected');
      if (blk.classList.contains('selected')) {
        blk.style.borderColor = '#0d6efd';
        blk.style.backgroundColor = '#e7f1ff';
      } else {
        blk.style.borderColor = '';
        blk.style.backgroundColor = '';
      }
      e.stopPropagation();
    }
  });

  // === MERGE TEXT FUNCTION ===
mergeBtn?.addEventListener('click', () => {
  const blocks = Array.from(document.querySelectorAll('.block'));

  if (!mergeMode) {
    mergeMode = true;
    mergeBlocksBtn.disabled = true;
    mergeBtn.textContent = 'Confirm Merge';
    mergeBtn.classList.replace('btn-warning', 'btn-success');
    return;
  }

  const selected = blocks.filter(b => b.classList.contains('selected'));
  if (selected.length < 2) {
    alert('Select at least two blocks to merge');
    return;
  }

  const firstBlock = selected[0];
  const firstTa = firstBlock.querySelector('textarea');
  let mergedText = '';

  selected.forEach(b => {
    const ta = b.querySelector('textarea');
    if (ta) mergedText += ta.value.trim() + '\n';
    else if (b.querySelector('table')) {
      const rows = Array.from(b.querySelectorAll('table tr')).map(tr =>
        Array.from(tr.querySelectorAll('input')).map(inp => inp.value).join('\t')
      );
      mergedText += rows.join('\n') + '\n';
    } else if (b.querySelector('img')) {
      mergedText += '[Image]\n';
    } else {
      mergedText += '[Non-text Block]\n';
    }
  });

  if (firstTa) {
    firstTa.value = mergedText.trim();
    firstTa.style.backgroundColor = 'lightgreen'; // ‚úÖ Green highlight after merge
  }

  // Delete the rest of the selected blocks
  selected.slice(1).forEach(b => {
    b.querySelector('.delete-flag').value = '1';
    b.style.display = 'none';
    b.classList.remove('selected');
  });

  // ‚úÖ Clear selection and border on first (merged into) block
  firstBlock.classList.remove('selected');
  firstBlock.style.borderColor = '';
  firstBlock.style.backgroundColor = '';

  // ‚úÖ Reset mode
  mergeMode = false;
  mergeBlocksBtn.disabled = false;
  mergeBtn.textContent = 'Merge Text';
  mergeBtn.classList.replace('btn-success', 'btn-warning');
});


  // === MERGE BLOCKS FUNCTION ===
mergeBlocksBtn?.addEventListener('click', () => {
  const blocks = Array.from(document.querySelectorAll('.block'));

  if (!mergeBlockMode) {
    mergeBlockMode = true;
    mergeBtn.disabled = true;
    mergeBlocksBtn.textContent = 'Confirm Block Merge';
    mergeBlocksBtn.classList.replace('btn-secondary', 'btn-success');
    return;
  }

  const selected = blocks.filter(b => b.classList.contains('selected'));
  if (selected.length < 2) {
    alert('Select at least two blocks to merge.');
    return;
  }

  const targetBlock = selected[0]; // First selected block = merge target

  selected.slice(1).forEach(b => {
    const content = Array.from(b.children).filter(el => !el.classList.contains('position-absolute'));
    content.forEach(el => {
      const clone = el.cloneNode(true);
      
      targetBlock.appendChild(clone);
    });
    b.querySelector('.delete-flag').value = '1';
    b.style.display = 'none';
    b.classList.remove('selected');
  });

  // Clean up selected class & styles on target block
  targetBlock.classList.remove('selected');
  targetBlock.style.borderColor = '';
  targetBlock.style.backgroundColor = '';

  mergeBlockMode = false;
  mergeBtn.disabled = false;
  mergeBlocksBtn.textContent = 'Merge Blocks';
  mergeBlocksBtn.classList.replace('btn-success', 'btn-secondary');
});


  // === AI-CLASSIFY STUB ===
  document.getElementById('ai-classify-btn')?.addEventListener('click', () => {
    alert('Auto-classify via AI not implemented yet.');
  });

  // === TABLE EDIT TOGGLE ===
  document.querySelectorAll('.toggle-table-controls').forEach(btn => {
    btn.addEventListener('click', () => {
      const idx = btn.getAttribute('data-index');
      const ctrls = document.querySelector(`.table-controls[data-index="${idx}"]`);
      ctrls.style.display = ctrls.style.display === 'none' ? 'block' : 'none';
    });
  });

  // === QUESTION MODAL HANDLING ===
  const questionModalEl = document.getElementById('questionModal');
  questionModalEl?.addEventListener('show.bs.modal', e => {
    const btn = e.relatedTarget;
    document.getElementById('modalBlockIndex').value = btn.getAttribute('data-block-index');
    document.getElementById('modalQuestionNumber').value = '';
    document.getElementById('modalQuestionText').value = '';
    document.getElementById('modalQuestionMarks').value = '';
  });

  document.getElementById('saveQuestionBtn')?.addEventListener('click', () => {
    const idx = document.getElementById('modalBlockIndex').value;
    const num = document.getElementById('modalQuestionNumber').value;
    const text = document.getElementById('modalQuestionText').value;
    const marks = document.getElementById('modalQuestionMarks').value;

    const block = document.querySelector(`.block[data-index="${idx}"]`);
    const hdr = block.querySelector(`input[name="text_${idx}"]`);

    if (hdr) hdr.value = num + ' ' + text;
    let sm = block.querySelector('small.text-muted');
    if (sm) sm.textContent = 'Marks: ' + marks;
    else if (hdr) {
      const div = document.createElement('div');
      div.innerHTML = `<small class="text-muted">Marks: ${marks}</small>`;
      hdr.parentNode.appendChild(div);
    }
    bootstrap.Modal.getInstance(questionModalEl).hide();
  });
});
</script>


{% endblock%}