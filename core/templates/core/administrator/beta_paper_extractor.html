{% extends 'core/base.html' %}
{% load static %}

{% block content %}
  {% if messages %}
    {% for msg in messages %}
      <div class="alert alert-{{ msg.tags }} alert-dismissible fade show" role="alert">
        {{ msg }}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
      </div>
    {% endfor %}
  {% endif %}

  <div class="container mt-5">
    <h2>Beta Paper Extractor â€“ Review &amp; Edit</h2>
    <form id="extractor-form" method="post" enctype="multipart/form-data">
      {% csrf_token %}
      <div class="mb-3">
        <label for="paper" class="form-label">Upload Document (PDF or DOCX)</label>
        <input type="file" class="form-control" id="paper" name="paper">
      </div>
      <div class="form-check mb-3">
        <input class="form-check-input" type="checkbox" id="crop_mode" name="crop_mode"
               {% if crop_mode %}checked{% endif %}>
        <label class="form-check-label" for="crop_mode">Enable Crop Mode</label>
      </div>
      <div class="form-check mb-3">
        <input class="form-check-input" type="checkbox" id="use_marks" name="use_marks"
               {% if use_marks %}checked{% endif %}>
        <label class="form-check-label" for="use_marks">Use Marks as Delimiter</label>
      </div>
      <input type="hidden" id="cropped_text" name="cropped_text">

      <button type="submit" class="btn btn-primary">Extract Questions</button>
      <button type="button" class="btn btn-secondary ms-2"
              data-bs-toggle="modal" data-bs-target="#rawTextModal">
        View Raw Text
      </button>
      
      {% if file_url %}
  <a href="{{ file_url }}" target="_blank" class="btn btn-outline-info ms-2">
    Download/View Original Upload
  </a>
{% endif %}

      {% if questions is not None %}
        <hr>
        <table class="table table-bordered" id="questions-table">
          <thead>
            <tr>
              <th>Number</th><th>Question</th><th>Marks</th><th>Case Study</th><th>Actions</th>
            </tr>
          </thead>
          <tbody>
            {# extracted #}
            {% for q in questions %}
            <tr>
              <td><input name="number_{{ forloop.counter }}" class="form-control" value="{{ q.number }}"></td>
              <td><textarea name="question_{{ forloop.counter }}" class="form-control">{{ q.question }}</textarea></td>
              <td><input name="marks_{{ forloop.counter }}" class="form-control" value="{{ q.marks }}"></td>
              <td><input name="case_study_{{ forloop.counter }}" class="form-control" value="{{ q.case_study }}"></td>
              <td>
                <button type="button" class="btn btn-sm btn-danger delete-row-btn">Delete</button>
              </td>
            </tr>
            {% endfor %}

            {# blanks up to 17 rows total #}
            {% for i in "12345678901234567" %}
            <tr>
              <td><input name="number_blank_{{ forloop.counter }}" class="form-control"></td>
              <td><textarea name="question_blank_{{ forloop.counter }}" class="form-control"></textarea></td>
              <td><input name="marks_blank_{{ forloop.counter }}" class="form-control"></td>
              <td><input name="case_study_blank_{{ forloop.counter }}" class="form-control"></td>
              <td>
                <button type="button" class="btn btn-sm btn-danger delete-row-btn">Delete</button>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>

        <button id="save-questions-btn" type="button" class="btn btn-success">
          Save to Question Bank
        </button>
      {% endif %}
    </form>
  </div>

  {# Raw Text Modal #}
  <div class="modal fade" id="rawTextModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Full Extracted Text</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <pre style="white-space: pre-wrap; max-height:70vh; overflow:auto;">
{{ raw_text|default:"(no text extracted)" }}
          </pre>
        </div>
      </div>
    </div>
  </div>

  {# Original Upload Modal #}
  {% if file_url %}
  <div class="modal fade" id="originalModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Original Uploaded File</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body p-0">
          <iframe src="{{ file_url }}" style="width:100%; height:80vh; border:none;"></iframe>
        </div>
      </div>
    </div>
  </div>
  {% endif %}
{% endblock %}

{% block scripts %}
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"
          integrity="sha256-/xUj+3OJ+Y2e+1hg4jeX4bFhQX1QpFje0mZ6qZczL+I="
          crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    (function($){
      // Delete any row
      $(document).on('click', '.delete-row-btn', function(){
        $(this).closest('tr').remove();
      });

      // Save
      $(document).on('click', '#save-questions-btn', function(){
        $('#extractor-form')
          .attr('action', '{% url "save_extracted_questions" %}')
          .submit();
      });
    })(jQuery);
  </script>
{% endblock %}
