{% extends 'core/base.html' %}
{% load static %}

{% block content %}
<div class="container mt-5">
  <h2>Beta Paper Extractor – Review & Edit</h2>

  <form id="extractor-form" method="post" enctype="multipart/form-data">
    {% csrf_token %}

    <div class="mb-3">
      <label for="paper" class="form-label">Upload Document (.docx only)</label>
      <input type="file" class="form-control" id="paper" name="paper">
    </div>

    <button type="submit" class="btn btn-primary">Extract Tables & Questions</button>

    {% if file_url %}
      <a href="{{ file_url }}" class="btn btn-outline-info ms-2" target="_blank">Download Original</a>
    {% endif %}

    <button type="button" class="btn btn-secondary ms-2" data-bs-toggle="modal" data-bs-target="#rawTextModal">
      View Raw Text
    </button>
  </form>

  {% if match_tables %}
    <hr>
    <h4>Match Column A ↔ Column B Tables</h4>
    {% for tbl in match_tables %}
      <div class="table-responsive mb-4">
        <table class="table table-bordered">
          <thead>
            <tr>
              {% for col in tbl.header %}
                <th>{{ col }}</th>
              {% endfor %}
            </tr>
          </thead>
          <tbody>
            {% for row in tbl.rows %}
              <tr>
                {% for cell in row %}
                  <td>{{ cell }}</td>
                {% endfor %}
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    {% endfor %}
  {% endif %}

  {% if mcq_tables %}
    <hr>
    <h4>Multiple Choice Tables</h4>
    {% for tbl in mcq_tables %}
      <div class="table-responsive mb-4">
        <table class="table table-striped table-hover">
          <thead>
            <tr>
              {% for col in tbl.header %}
                <th>{{ col }}</th>
              {% endfor %}
            </tr>
          </thead>
          <tbody>
            {% for row in tbl.rows %}
              <tr>
                {% for cell in row %}
                  <td>{{ cell }}</td>
                {% endfor %}
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    {% endfor %}
  {% endif %}

  {% if questions %}
    <hr>
    <h4>Structured Questions</h4>
    <form method="post" action="{% url 'save_extracted_questions' %}">
      {% csrf_token %}
      <div class="table-responsive">
        <table class="table table-bordered align-middle">
          <thead>
            <tr class="table-secondary">
              <th>Number</th>
              <th>Instruction</th>
              <th>Question Text</th>
              <th>Case Study</th>
              <th>Marks</th>
            </tr>
          </thead>
          <tbody>
            {% for number, q in questions.items %}
              <tr>
                <td><input type="text" name="number_{{ forloop.counter }}" value="{{ number }}" class="form-control"></td>
                <td><textarea name="instruction_{{ forloop.counter }}" class="form-control" rows="2">{{ q.instruction }}</textarea></td>
                <td><textarea name="question_{{ forloop.counter }}" class="form-control" rows="3">{{ q.question_text }}</textarea></td>
                <td><textarea name="case_study_{{ forloop.counter }}" class="form-control" rows="3">{{ q.case_study }}</textarea></td>
                <td><input type="text" name="marks_{{ forloop.counter }}" value="{{ q.marks }}" class="form-control"></td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      <button type="submit" class="btn btn-success mt-3">Save Structured Questions</button>
    </form>
  {% endif %}
</div>

<!-- Modal for Raw Extracted Text -->
<div class="modal fade" id="rawTextModal" tabindex="-1">
  <div class="modal-dialog modal-xl">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Raw Extracted Text</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <pre style="white-space:pre-wrap; max-height:70vh; overflow:auto;">
{{ raw_text|default:"(No text extracted)" }}
        </pre>
      </div>
    </div>
  </div>
</div>
{% endblock %}
